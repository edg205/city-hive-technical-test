<div class="page">
  <div class="header">
    <h2>Messages</h2>

    <div class="header-actions">
      <button
        type="button"
        class="secondary"
        (click)="refresh()"
        [disabled]="loading() || refreshing()"
      >
        {{ refreshing() ? 'Refreshing…' : 'Refresh' }}
      </button>

      <button type="button" class="secondary" (click)="logout()">
        Logout
      </button>
    </div>
  </div>

  @if (error()) {
    <p class="error" role="alert">{{ error() }}</p>
  }

  @if (loading()) {
    <p class="muted">Loading…</p>
  } @else {
    <div class="list">
      @if (messages().length === 0) {
        <p class="muted">No messages yet.</p>
      } @else {
        <div class="row header-row">
          <div>To</div>
          <div>Body</div>
          <div>Status</div>
        </div>

        @for (m of messages(); track m.id ?? m.twilio_sid) {
          <div class="row">
            <div class="mono">{{ m.to_number }}</div>
            <div class="wrap">{{ m.body }}</div>
            <div class="mono">{{ m.status }}</div>
          </div>
        }

      }
    </div>
  }

  <hr />

  <form class="compose" (ngSubmit)="send()" novalidate>
    <h3>Send a message</h3>

    <label>
      To number
      <input
        name="toNumber"
        [ngModel]="toNumberRaw()"
        (ngModelChange)="toNumberRaw.set($event)"
        (blur)="touchedTo.set(true)"
        placeholder="+15555551212"
        required
        [attr.aria-invalid]="showPhoneHint() ? 'true' : null"
      />
    </label>

    @if (showPhoneHint()) {
      <p class="hint">
        Phone number must be in international (E.164) format,
        e.g. <code>+15555551212</code>
      </p>
    }

    <label>
      Body
      <textarea
        name="body"
        rows="3"
        required
        [ngModel]="body()"
        (ngModelChange)="body.set($event)"
        (blur)="touchedBody.set(true)"
        [attr.aria-invalid]="touchedBody() && !body().trim() ? 'true' : null"
      ></textarea>
    </label>

    @if (touchedBody() && !body().trim()) {
      <p class="hint">Message body is required.</p>
    }

    <button
      type="submit"
      [disabled]="!canSend()"
      [attr.aria-busy]="sending()"
    >
      {{ sending() ? 'Sending…' : 'Send' }}
    </button>
  </form>
</div>
